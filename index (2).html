<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#0b0f1a" />
<title>Starfall Survivor — Legendary Single‑File</title>
<style>
  :root{
    --bg:#0b0f1a; --bg2:#0f1830;
    --fg:#e6ecff; --dim:#b7c3e0;
    --accent:#6ab3ff; --accent2:#9d7bff;
    --ok:#39d98a; --warn:#ffd166; --danger:#ff5c7a;
    --panel: rgba(12,16,28,.6); --panel-bd: rgba(106,179,255,.22);
    --glass: blur(14px) saturate(1.2); --shadow: 0 10px 40px rgba(10,14,30,.6);
  }
  html, body { margin:0; height:100%; background: radial-gradient(1200px 800px at 50% 40%, var(--bg2), var(--bg)); color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Noto Sans", Arial; overflow:hidden; }
  #game { position:fixed; inset:0; width:100%; height:100%; display:block; }

  /* HUD */
  #hud { position:fixed; inset:0; pointer-events:none; display:grid; grid-template-rows:auto 1fr auto; padding:12px; }
  #hudTop { display:flex; gap:12px; justify-content:space-between; align-items:flex-start; pointer-events:auto; }
  .bars { display:grid; gap:10px; }
  .bar {
    position:relative; width:min(360px,46vw); height:16px; border-radius:999px; overflow:hidden;
    background: linear-gradient(180deg, rgba(16,24,44,.65), rgba(16,24,44,.35));
    border: 1px solid #2a3657;
    box-shadow: inset 0 2px 6px rgba(0,0,0,.35), 0 6px 22px rgba(10,14,30,.35);
  }
  .bar .fill {
    height:100%; width:100%;
    background: linear-gradient(90deg, #39d98a, #7ff0c6);
    box-shadow: inset 0 0 12px #7ff0c644, 0 0 14px #7ff0c633;
    transition: width 120ms linear;
    position:relative;
  }
  .bar .fill::after {
    content:""; position:absolute; inset:0;
    background-image: linear-gradient(120deg, rgba(255,255,255,.18) 0%, rgba(255,255,255,0) 40%);
    mix-blend-mode: screen; pointer-events:none;
  }
  .bar.shield .fill { background: linear-gradient(90deg, #6ab3ff, #9d7bff); box-shadow: inset 0 0 12px #6ab3ff44, 0 0 14px #9d7bff33; }
  .bar.xp .fill     { background: linear-gradient(90deg, #ffd166, #ff9f1c); box-shadow: inset 0 0 12px #ffd16644, 0 0 14px #ff9f1c33; }
  .bar-label { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:.8rem; color:#d3dbf7cc; text-shadow:0 1px 0 #0009; }

  .pill { background:rgba(15,24,48,.65); border:1px solid #2a3657; border-radius:10px; padding:8px 12px; box-shadow:0 4px 18px rgba(10,14,30,.35); display:flex; gap:10px; align-items:center; }
  .stat { font-weight:800; }
  #hudBottom { display:flex; justify-content:space-between; align-items:center; color:var(--dim); padding:2px 4px; }

  /* Screens */
  .screen { position:fixed; inset:0; display:grid; place-items:center; z-index:5; transition:opacity .2s ease; }
  .hidden { opacity:0; pointer-events:none; }
  .overlay { background:rgba(0,0,0,.6); }
  .panel {
    width:min(780px,92vw); padding:22px; border-radius:16px;
    background:var(--panel); border:1px solid var(--panel-bd);
    backdrop-filter:var(--glass); box-shadow:var(--shadow); text-align:center;
  }
  .title { font-weight:900; font-size:2rem; margin:4px 0 8px; }
  .tag { color:var(--dim); margin-bottom:10px; }
  .actions { display:grid; gap:10px; justify-items:center; margin-top:12px; }
  .btn { --bg:#141c31; --bd:#2a3657; border:1px solid var(--bd); background: var(--bg); color:var(--fg); padding:.8rem 1.2rem; border-radius:12px; font-weight:800; cursor:pointer; }
  .btn:hover { border-color:var(--accent); box-shadow:0 0 0 4px #6ab3ff22; }
  .btn.primary { --bg:linear-gradient(180deg, color-mix(in srgb, var(--accent) 25%, #0f1830), #0c1526); --bd: color-mix(in srgb, var(--accent) 38%, #2a3657); }
  .row { display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
  .key { padding:.2rem .5rem; border-radius:8px; background:#0f1830; border:1px solid #2a3657; font-weight:800; }

  /* Toasts */
  #toasts { position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:6; display:grid; gap:8px; width:min(560px,92vw); pointer-events:none; }
  .toast { pointer-events:auto; background:rgba(15,24,48,.9); border:1px solid #2a3657; color:var(--fg); padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); }

  @media (prefers-reduced-motion: reduce) { * { transition:none !important; animation:none !important; } }
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- HUD -->
<div id="hud">
  <div id="hudTop">
    <div class="bars">
      <div class="bar hp"><div id="hpFill" class="fill" style="width:100%"></div><span class="bar-label">HP (Green)</span></div>
      <div class="bar shield"><div id="shFill" class="fill" style="width:100%"></div><span class="bar-label">Shield (Blue)</span></div>
      <div class="bar xp"><div id="xpFill" class="fill" style="width:0%"></div><span class="bar-label">XP (Yellow)</span></div>
    </div>
    <div class="pill">
      <span id="score" class="stat">Score: 0</span>
      <span id="time" class="stat">Time: 00:00</span>
      <span id="wave" class="stat">Wave: 1</span>
      <span id="fps" class="stat">FPS: —</span>
      <button id="pauseBtn" class="btn">Pause</button>
    </div>
  </div>
  <div></div>
  <div id="hudBottom">
    <div id="objective">Survive. Move with WASD. Shoot with Mouse/Space.</div>
    <div id="combo">Combo x1.0</div>
  </div>
</div>

<!-- Screens -->
<div id="menu" class="screen">
  <div class="panel">
    <div class="title">Starfall Survivor</div>
    <div class="tag">Build. Adapt. Survive the cosmic onslaught.</div>
    <div class="actions">
      <button id="playBtn" class="btn primary">Play</button>
      <div class="row">
        <button id="infoBtn" class="btn">Info</button>
        <button id="controlsBtn" class="btn">Controls</button>
        <button id="creditsBtn" class="btn">Credits</button>
      </div>
    </div>
  </div>
</div>

<div id="info" class="screen overlay hidden" aria-modal="true">
  <div class="panel" style="text-align:left;">
    <div class="title">Info</div>
    <p class="tag">Understand your HUD and scoring.</p>
    <ul>
      <li><strong>HP (Green):</strong> Your health. If it reaches 0, you die.</li>
      <li><strong>Shield (Blue):</strong> Absorbs incoming damage first and slowly regenerates.</li>
      <li><strong>XP (Yellow):</strong> Fill by collecting shards and orange Cores dropped by big enemies.</li>
      <li><strong>Score:</strong> Increases over time, by defeating enemies, and collecting shards/cores.</li>
      <li><strong>Waves:</strong> From Wave 3, shooter enemies begin firing at you.</li>
    </ul>
    <div class="actions">
      <button id="infoBack" class="btn">Back</button>
    </div>
  </div>
</div>

<div id="controls" class="screen overlay hidden" aria-modal="true">
  <div class="panel">
    <div class="title">Controls</div>
    <div class="row" style="color:var(--dim)">
      <span class="key">WASD</span> Move
      <span class="key">Mouse</span> Aim
      <span class="key">LMB / Space</span> Shoot
      <span class="key">Shift</span> Dash
      <span class="key">Esc</span> Pause
    </div>
    <div class="actions">
      <button id="controlsBack" class="btn">Back</button>
    </div>
  </div>
</div>

<div id="credits" class="screen overlay hidden" aria-modal="true">
  <div class="panel">
    <div class="title">Credits</div>
    <p class="tag">This game has been developed by <strong>Muhammad Hammad Saleem</strong> from <strong>Lahore, Pakistan</strong>.</p>
    <div class="actions">
      <button id="creditsBack" class="btn">Back</button>
    </div>
  </div>
</div>

<div id="pause" class="screen overlay hidden">
  <div class="panel">
    <div class="title">Paused</div>
    <div class="actions">
      <button id="resumeBtn" class="btn primary">Resume</button>
      <button id="restartBtn" class="btn">Restart</button>
      <button id="menuBtn" class="btn">Main Menu</button>
    </div>
  </div>
</div>

<div id="over" class="screen overlay hidden">
  <div class="panel">
    <div class="title">Game Over</div>
    <div class="tag" id="finalStats">Score: 0 • Time: 00:00 • Wave: 1</div>
    <div class="actions">
      <button id="retryBtn" class="btn primary">Retry</button>
      <button id="backBtn" class="btn">Main Menu</button>
    </div>
  </div>
</div>

<div id="toasts"></div>

<script>
(()=>{'use strict';
/* ===== Utilities ===== */
const cv=document.getElementById('game'), ctx=cv.getContext('2d',{alpha:false});
let DPR=1,W=1280,H=720;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const TAU=Math.PI*2, nowSec=()=>performance.now()/1000;
function fit(){DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));const w=innerWidth,h=innerHeight;cv.width=Math.floor(w*DPR);cv.height=Math.floor(h*DPR);cv.style.width=w+'px';cv.style.height=h+'px';W=cv.width;H=cv.height;}
addEventListener('resize',fit); fit();
const RNG={s:(Date.now()^0x9e3779b9)>>>0,next(){let x=this.s|0;x^=x<<13;x^=x>>>17;x^=x<<5;this.s=x|0;return (x>>>0)/2**32;},range(a,b){return a+(b-a)*this.next();},pick(a){return a[(this.next()*a.length)|0];}};

/* ===== DOM ===== */
const screens={menu:menu,info:info,controls:controls,credits:credits,pause:pause,over:over};
const hud={hp:hpFill,sh:shFill,xp:xpFill,score:score,time:time,wave:wave,fps:fps,objective:objective,combo:combo};
const btn={play:playBtn,info:infoBtn,controls:controlsBtn,credits:creditsBtn,infoBack:infoBack,controlsBack:controlsBack,creditsBack:creditsBack,pause:pauseBtn,resume:resumeBtn,restart:restartBtn,menu:menuBtn,retry:retryBtn,back:backBtn};
function hideAllScreens(){ Object.values(screens).forEach(s=>s.classList.add('hidden')); }
function showOnly(el){ hideAllScreens(); if(el) el.classList.remove('hidden'); }

/* ===== Input ===== */
const Input={keys:new Set(),mouse:{x:W/2,y:H/2},shooting:false,dash:false};
addEventListener('keydown',e=>{ const k=e.key.toLowerCase(); if(State.scene==='PLAY'&&(e.code==='Space'||k===' '||k==='space'||k==='spacebar')) e.preventDefault(); Input.keys.add(k); if(k===' '||k==='space'||k==='enter') Input.shooting=true; if(k==='shift') Input.dash=true; if(k==='escape') togglePause(); },false);
addEventListener('keyup',e=>{ const k=e.key.toLowerCase(); Input.keys.delete(k); if(k===' '||k==='space'||k==='enter') Input.shooting=false; if(k==='shift') Input.dash=false; },false);
cv.addEventListener('mousemove',e=>{ const r=cv.getBoundingClientRect(), sx=cv.width/r.width, sy=cv.height/r.height; Input.mouse.x=(e.clientX-r.left)*sx; Input.mouse.y=(e.clientY-r.top)*sy; },{passive:true});
cv.addEventListener('mousedown',e=>{ if(State.scene==='PLAY'&&e.button===0) Input.shooting=true; },{passive:true});
addEventListener('mouseup',e=>{ if(e.button===0) Input.shooting=false; },{passive:true});
function axis(){let x=0,y=0;if(Input.keys.has('a')||Input.keys.has('arrowleft'))x-=1;if(Input.keys.has('d')||Input.keys.has('arrowright'))x+=1;if(Input.keys.has('w')||Input.keys.has('arrowup'))y-=1;if(Input.keys.has('s')||Input.keys.has('arrowdown'))y+=1;const m=Math.hypot(x,y)||1;return {x:x/m,y:y/m};}

/* ===== Audio (safe) ===== */
const AudioSys=(()=>{let ac,master,unlocked=false;function ensure(){if(ac)return true;try{ac=new (AudioContext||webkitAudioContext)();master=ac.createGain();master.gain.value=.25;master.connect(ac.destination);return true;}catch{return false;}}function unlock(){if(unlocked)return;if(!ensure())return;const o=ac.createOscillator(),g=ac.createGain();g.gain.value=0;o.connect(g).connect(master);o.start();o.stop(ac.currentTime+.01);unlocked=true;removeEventListener('pointerdown',unlock);}addEventListener('pointerdown',unlock,{once:true});function beep(f=660,d=.05,v=.15){if(!ensure())return;const o=ac.createOscillator(),g=ac.createGain();o.type='triangle';o.frequency.value=f;g.gain.value=v;o.connect(g).connect(master);const t=ac.currentTime;o.start(t);o.stop(t+d);}return{click(){beep(620,.05,.12);},ping(){beep(820,.06,.18);},thump(){beep(140,.09,.22);}}})();

/* ===== State ===== */
let inMenu=true;
const State={scene:'MENU',running:false,paused:false,over:false,time:{last:nowSec(),acc:0,fixed:1/120,fps:0,fpsCount:0,fpsTime:0},score:0,wave:1,elapsed:0,player:null,bullets:[],enemies:[],picks:[],parts:[], eBullets:[], // enemy bullets
  spawner:{t:0,cd:1.6,gate:20,waveT:0}
};

/* ===== Entities ===== */
class Player{constructor(){this.x=W/2;this.y=H*.72;this.r=Math.max(12,Math.min(24,Math.floor(H/40)));this.speed=Math.max(220,W*.25);this.hp=100;this.hpMax=100;this.sh=50;this.shMax=50;this.xp=0;this.lv=1;this.next=25;this.inv=0;this.aimX=this.x;this.aimY=this.y-100;this.cd=0;this.fireRate=.14;this.dmg=12;this.proj=820;this.pierce=0;this.combo=1;this.ct=0;this.dashT=0;this.dashCd=2;this.ammo=999;}update(dt){const a=axis(), dash=Input.dash&&this.dashT<=0;const sp=dash?this.speed*1.75:this.speed;this.x+=a.x*sp*dt;this.y+=a.y*sp*dt;this.x=clamp(this.x,this.r+4,W-this.r-4);this.y=clamp(this.y,this.r+4,H-this.r-4);this.inv=Math.max(0,this.inv-dt);this.dashT=Math.max(0,this.dashT-dt);if(dash)this.dashT=this.dashCd;this.aimX=lerp(this.aimX,Input.mouse.x||this.aimX,.22);this.aimY=lerp(this.aimY,Input.mouse.y||this.aimY,.22);this.ct+=dt;if(this.ct>3.5){this.combo=Math.max(1,this.combo-.25);this.ct=0;}this.cd-=dt;if(Input.shooting&&this.cd<=0&&this.ammo>0){this.cd=this.fireRate;this.ammo--;shoot(this);AudioSys.click();}if(this.sh<this.shMax)this.sh=Math.min(this.shMax,this.sh+dt*2.5);}draw(g){g.save();const ga=g.createRadialGradient(this.x,this.y,2,this.x,this.y,this.r*2.4);ga.addColorStop(0,'rgba(120,200,255,0.18)');ga.addColorStop(1,'rgba(120,200,255,0)');g.fillStyle=ga;g.beginPath();g.arc(this.x,this.y,this.r*2.2,0,TAU);g.fill();g.shadowBlur=14;g.shadowColor='rgba(120,200,255,0.6)';g.fillStyle='#a8dbff';g.beginPath();g.moveTo(this.x,this.y-this.r*1.25);g.lineTo(this.x-this.r*0.9,this.y+this.r*0.9);g.lineTo(this.x+this.r*0.9,this.y+this.r*0.9);g.closePath();g.fill();g.shadowBlur=0;g.strokeStyle='#bfe0ffcc';g.lineWidth=1.5;g.beginPath();g.arc(this.aimX,this.aimY,10,0,TAU);g.stroke();g.restore();}hit(d){if(this.inv>0)return;if(this.sh>0){const a=Math.min(this.sh,d);this.sh-=a;d-=a;}if(d>0){this.hp-=d;this.inv=.4;}burst(this.x,this.y,'#ffd0dc',12,280);if(this.hp<=0)endRun();}gainXP(v){const mult=1+(this.combo-1)*.2;this.xp+=v*mult;this.combo=Math.min(10,this.combo+.1);this.ct=0;if(this.xp>=this.next){this.xp-=this.next;this.lv++;this.next=Math.floor(this.next*1.35+12);levelUp();}}}
class Enemy{constructor(kind='chaser',hp=30,speed=100,r=16){this.kind=kind;this.x=0;this.y=-30;this.r=r;this.speed=speed;this.hp=hp;this.maxHP=hp;this.tw=RNG.range(.8,1.6);this.fireT=RNG.range(.6,1.2);}update(dt){const p=State.player;if(!p)return;const dx=p.x-this.x,dy=p.y-this.y,m=Math.hypot(dx,dy)||1,ux=dx/m,uy=dy/m;if(this.kind==='chaser'){this.x+=ux*this.speed*dt;this.y+=uy*this.speed*dt;}else if(this.kind==='strafer'){const tx=-uy,ty=ux;const o=Math.sin(State.elapsed*this.tw);this.x+=(ux*.7+tx*o*.7)*this.speed*dt;this.y+=(uy*.7+ty*o*.7)*this.speed*dt;}else if(this.kind==='brute'){this.x+=ux*this.speed*.65*dt;this.y+=uy*this.speed*.65*dt;}else{ // 'shooter'
  const desired=320, dir=(m>desired)?1:-1; this.x+=ux*this.speed*.8*dir*dt; this.y+=uy*this.speed*.8*dir*dt;
  if (State.wave>=3){ this.fireT-=dt; if(this.fireT<=0){ this.fireT=RNG.range(.8,1.4); fireEnemyBullet(this, ux, uy); } }
}}draw(g){g.save();g.fillStyle=this.kind==='brute'?'#ff6b6b':this.kind==='strafer'?'#ffa8d1':this.kind==='shooter'?'#ffcf66':'#ff8aa6';g.beginPath();g.arc(this.x,this.y,this.r,0,TAU);g.fill();g.fillStyle='rgba(255,255,255,.18)';g.fillRect(this.x-this.r,this.y-this.r-8,this.r*2,4);g.fillStyle='#ff5c7a';g.fillRect(this.x-this.r,this.y-this.r-8,this.r*2*(this.hp/this.maxHP),4);g.restore();}}
class Bullet{constructor(){this.x=0;this.y=0;this.vx=0;this.vy=0;this.r=5;this.life=1.8;this.dmg=12;this.pierce=0;this.alive=true;}update(dt){this.life-=dt;if(this.life<=0){this.alive=false;return;}this.x+=this.vx*dt;this.y+=this.vy*dt;if(this.x<-40||this.x>W+40||this.y<-40||this.y>H+40)this.alive=false;}draw(g){g.save();g.fillStyle='#79f0ff';g.beginPath();g.arc(this.x,this.y,this.r,0,TAU);g.fill();g.restore();}}
class EnemyBullet{constructor(){this.x=0;this.y=0;this.vx=0;this.vy=0;this.r=4;this.alive=true;this.life=3;this.dmg=14;}update(dt){this.life-=dt;if(this.life<=0){this.alive=false;return;}this.x+=this.vx*dt;this.y+=this.vy*dt;if(this.x<-50||this.x>W+50||this.y<-50||this.y>H+50)this.alive=false;}draw(g){g.save();g.fillStyle='#ff7a9e';g.beginPath();g.arc(this.x,this.y,this.r,0,TAU);g.fill();g.restore();}}
class Pickup{constructor(kind='shard',val=6){this.kind=kind;this.x=0;this.y=0;this.r=kind==='core'?10:6;this.vx=0;this.vy=0;this.val=val;this.alive=true;}update(dt){const p=State.player;if(!p)return;const dx=p.x-this.x,dy=p.y-this.y,m=Math.hypot(dx,dy)||1;const magnet=this.kind==='core'?260:220;if(m<magnet){this.vx+=(dx/m)*(this.kind==='core'?160:180)*dt;this.vy+=(dy/m)*(this.kind==='core'?160:180)*dt;}this.vx*=.985;this.vy*=.985;this.x+=this.vx*dt;this.y+=this.vy*dt;if(m<this.r+p.r){this.alive=false;p.gainXP(this.val);State.score+=this.val;toast(this.kind==='core'?'+CORE XP':'+XP');}}draw(g){g.save();g.fillStyle=this.kind==='core'?'#ffa24d':'#82f0b8';g.beginPath();g.arc(this.x,this.y,this.r,0,TAU);g.fill();g.restore();}}
class Particle{constructor(){this.x=0;this.y=0;this.vx=0;this.vy=0;this.life=0;this.max=1;this.size=2;this.color='#fff';}update(dt){this.life-=dt;this.x+=this.vx*dt;this.y+=this.vy*dt;this.vx*=.985;this.vy*=.985;}draw(g){const a=Math.max(0,this.life/this.max);if(a<=0)return;g.save();g.globalAlpha=a;g.fillStyle=this.color;g.beginPath();g.arc(this.x,this.y,this.size,0,TAU);g.fill();g.restore();}}

/* ===== Background ===== */
const Stars={A:[],B:[],C:[],init(){this.A.length=this.B.length=this.C.length=0;for(let i=0;i<120;i++)this.A.push({x:RNG.range(0,W),y:RNG.range(0,H),s:RNG.range(.6,1.4),a:RNG.range(.3,.8),t:RNG.range(0,TAU),tw:RNG.range(.4,1.2)});for(let i=0;i<76;i++)this.B.push({x:RNG.range(0,W),y:RNG.range(0,H),s:RNG.range(1.2,2.2),a:RNG.range(.4,.9),t:RNG.range(0,TAU),tw:RNG.range(.3,1)});for(let i=0;i<48;i++)this.C.push({x:RNG.range(0,W),y:RNG.range(0,H),s:RNG.range(1.8,2.8),a:RNG.range(.5,1),t:RNG.range(0,TAU),tw:RNG.range(.2,.8)});},update(dt){const drift=(arr,s)=>{for(const st of arr){st.y+=s*dt;st.t+=st.tw*dt;if(st.y>H+4){st.y=-4;st.x=RNG.range(0,W);}}};drift(this.A,16);drift(this.B,36);drift(this.C,64);},draw(g){const grad=g.createLinearGradient(0,0,0,H);grad.addColorStop(0,'#060913');grad.addColorStop(1,'#0b0f1a');g.fillStyle=grad;g.fillRect(0,0,W,H);const draw=(arr,col)=>{g.save();for(const st of arr){const k=.65+.35*Math.sin(st.t);g.globalAlpha=st.a*k;g.fillStyle=col;g.beginPath();g.arc(st.x,st.y,st.s,0,TAU);g.fill();}g.restore();};draw(this.A,'#cfe4ff');draw(this.B,'#dfe9ff');draw(this.C,'#ffffff');}};

/* ===== Pools & FX ===== */
function makePool(f){const free=[],live=new Set();return{get(){const o=free.pop()||f();live.add(o);return o;},release(o){live.delete(o);free.push(o);}};}
const partPool=makePool(()=>new Particle());
function burst(x,y,color='#ffd3dd',count=14,speed=240){for(let i=0;i<count;i++){const p=partPool.get();p.life=p.max=RNG.range(.25,.6);p.x=x;p.y=y;const a=RNG.range(0,TAU);const sp=RNG.range(speed*.5,speed);p.vx=Math.cos(a)*sp;p.vy=Math.sin(a)*sp;p.size=RNG.range(1.5,3.5);p.color=color;State.parts.push(p);}}
function muzzle(x,y,ux,uy){for(let i=0;i<6;i++){const p=partPool.get();p.life=p.max=RNG.range(.12,.22);p.x=x;p.y=y;const t={x:-uy,y:ux};const sp=RNG.range(120,220);p.vx=ux*sp+t.x*RNG.range(-40,40);p.vy=uy*sp+t.y*RNG.range(-40,40);p.size=RNG.range(1.5,2.5);p.color='#c6fbff';State.parts.push(p);}}

/* ===== World helpers ===== */
function shoot(pl){const dx=pl.aimX-pl.x,dy=pl.aimY-pl.y,m=Math.hypot(dx,dy)||1,ux=dx/m,uy=dy/m;const b=new Bullet();b.x=pl.x+ux*(pl.r+10);b.y=pl.y+uy*(pl.r+10);b.vx=ux*pl.proj;b.vy=uy*pl.proj;b.dmg=pl.dmg;b.pierce=pl.pierce;State.bullets.push(b);muzzle(pl.x+ux*(pl.r+6),pl.y+uy*(pl.r+6),ux,uy);}
function fireEnemyBullet(e,ux,uy){const s=280+State.wave*6;const eb=new EnemyBullet();eb.x=e.x+ux*(e.r+6);eb.y=e.y+uy*(e.r+6);eb.vx=ux*s;eb.vy=uy*s;State.eBullets.push(eb);}
function circleHit(ax,ay,ar,bx,by,br){const dx=ax-bx,dy=ay-by,rr=ar+br;return dx*dx+dy*dy<=rr*rr;}
function levelUp(){const ups=[()=>{State.player.dmg+=3;toast('Upgrade: +Damage');},()=>{State.player.fireRate=Math.max(.08,State.player.fireRate*.93);toast('Upgrade: Fire Rate');},()=>{State.player.pierce+=1;toast('Upgrade: Pierce +1');},()=>{State.player.shMax+=10;State.player.sh+=10;toast('Upgrade: Shield +10');},()=>{State.player.hpMax+=10;State.player.hp+=10;toast('Upgrade: HP +10');},()=>{State.player.proj+=40;toast('Upgrade: Projectile Speed');},()=>{State.player.speed+=16;toast('Upgrade: Move Speed');}];RNG.pick(ups)();AudioSys.ping();}
function spawnUpdate(dt){const s=State.spawner;s.t+=dt;s.waveT+=dt;if(s.t>=s.cd){s.t=0;const types=['chaser','strafer','shooter','chaser','brute'];const type=RNG.pick(types);const hp=24+State.wave*3+(type==='brute'?36:0);const sp=90+State.wave*2+(type==='strafer'?20:0);const r=type==='brute'?22:16;const e=new Enemy(type,hp,sp,r);const edge=RNG.pick(['top','left','right']);if(edge==='top'){e.x=RNG.range(40,W-40);e.y=-30;}if(edge==='left'){e.x=-30;e.y=RNG.range(40,H-40);}if(edge==='right'){e.x=W+30;e.y=RNG.range(40,H-40);}State.enemies.push(e);s.cd=Math.max(.6,s.cd*.99);}if(s.waveT>=s.gate){s.waveT=0;State.wave++;toast('Wave '+State.wave);}}

/* ===== HUD & Toast ===== */
function updHUD(){const p=State.player;if(!p)return;hud.hp.style.width=(clamp(p.hp/p.hpMax,0,1)*100)+'%';hud.sh.style.width=(clamp(p.sh/p.shMax,0,1)*100)+'%';hud.xp.style.width=(clamp(p.xp/p.next,0,1)*100)+'%';hud.score.textContent='Score: '+Math.floor(State.score);hud.wave.textContent='Wave: '+State.wave;const t=State.elapsed|0,m=(t/60|0).toString().padStart(2,'0'),s=(t%60).toString().padStart(2,'0');hud.time.textContent='Time: '+m+':'+s;hud.fps.textContent='FPS: '+State.time.fps;hud.objective.textContent=State.wave>=3?'Survive. Shooters online.':'Survive the wave';hud.combo.textContent='Combo x'+State.player.combo.toFixed(1);}
function toast(text,ms=1400){const box=document.getElementById('toasts');const n=document.createElement('div');n.className='toast';n.textContent=text;box.appendChild(n);setTimeout(()=>n.remove(),ms);}

/* ===== Flow ===== */
function startRun(){inMenu=false;document.activeElement?.blur();State.running=true;State.paused=false;State.over=false;State.scene='PLAY';State.player=new Player();State.bullets.length=0;State.enemies.length=0;State.picks.length=0;State.parts.length=0;State.eBullets.length=0;State.score=0;State.wave=1;State.elapsed=0;State.spawner.t=0;State.spawner.cd=1.6;State.spawner.gate=20;State.spawner.waveT=0;Stars.init();hideAllScreens();updHUD();}
function endRun(){if(State.over)return;State.over=true;State.running=false;const t=State.elapsed|0,m=(t/60|0).toString().padStart(2,'0'),s=(t%60).toString().padStart(2,'0');finalStats.textContent=`Score: ${Math.floor(State.score)} • Time: ${m}:${s} • Wave: ${State.wave}`;showOnly(screens.over);}
function togglePause(){if(State.scene!=='PLAY'||!State.running)return;State.paused=!State.paused;showOnly(State.paused?screens.pause:null);}

/* ===== Buttons ===== */
btn.play.addEventListener('click',()=>{AudioSys.click();showOnly(null);startRun();});
btn.info.addEventListener('click',()=>{if(!inMenu)return;AudioSys.click();showOnly(screens.info);});
btn.controls.addEventListener('click',()=>{if(!inMenu)return;AudioSys.click();showOnly(screens.controls);});
btn.credits.addEventListener('click',()=>{if(!inMenu)return;AudioSys.click();showOnly(screens.credits);});
btn.infoBack.addEventListener('click',()=>{AudioSys.click();showOnly(screens.menu);});
btn.controlsBack.addEventListener('click',()=>{AudioSys.click();showOnly(screens.menu);});
btn.creditsBack.addEventListener('click',()=>{AudioSys.click();showOnly(screens.menu);});
btn.pause.addEventListener('click',togglePause);
btn.resume.addEventListener('click',()=>{AudioSys.click();State.paused=false;showOnly(null);});
btn.restart.addEventListener('click',()=>{AudioSys.click();startRun();});
btn.menu.addEventListener('click',()=>{AudioSys.click();inMenu=true;State.scene='MENU';State.running=false;showOnly(screens.menu);});
btn.retry.addEventListener('click',()=>{AudioSys.click();startRun();});
btn.back.addEventListener('click',()=>{AudioSys.click();inMenu=true;State.scene='MENU';State.running=false;showOnly(screens.menu);});

/* ===== Step / Draw / Loop ===== */
function step(dt){
  State.elapsed+=dt;
  Stars.update(dt);
  State.player?.update(dt);
  spawnUpdate(dt);

  // Enemies
  for(let i=State.enemies.length-1;i>=0;i--){
    const e=State.enemies[i]; e.update(dt);
    if(e.x<-140||e.x>W+140||e.y<-160||e.y>H+160) State.enemies.splice(i,1);
  }

  // Enemy bullets
  for(let i=State.eBullets.length-1;i>=0;i--){
    const eb=State.eBullets[i]; eb.update(dt);
    if(!eb.alive){ State.eBullets.splice(i,1); continue; }
    const p=State.player;
    if(p && circleHit(eb.x,eb.y,eb.r,p.x,p.y,p.r)){ p.hit(eb.dmg); burst(eb.x,eb.y,'#ff9bb6',6,200); State.eBullets.splice(i,1); }
  }

  // Player bullets
  for(let i=State.bullets.length-1;i>=0;i--){
    const b=State.bullets[i]; b.update(dt);
    if(!b.alive){ State.bullets.splice(i,1); continue; }
    for(let j=State.enemies.length-1;j>=0;j--){
      const e=State.enemies[j];
      if(circleHit(b.x,b.y,b.r,e.x,e.y,e.r)){
        e.hp-=b.dmg; burst(b.x,b.y,'#9df2ff',6,260);
        if(e.hp<=0){
          State.score += 10 + (e.maxHP/4|0);
          burst(e.x,e.y,'#ffd0dc',12,340);

          // Drop XP shard for all enemies
          const shard=new Pickup('shard', 6+(e.maxHP/10|0)); shard.x=e.x; shard.y=e.y; shard.vx=RNG.range(-90,90); shard.vy=RNG.range(-120,40); State.picks.push(shard);

          // Big enemies drop a Core (large XP)
          if(e.kind==='brute' || e.maxHP>=60){
            const core=new Pickup('core', 20 + (State.wave*2|0));
            core.x=e.x; core.y=e.y; core.vx=RNG.range(-60,60); core.vy=RNG.range(-60,60);
            State.picks.push(core);
          }

          State.enemies.splice(j,1);
        }
        if(b.pierce>0) b.pierce--; else { b.alive=false; State.bullets.splice(i,1); }
        break;
      }
    }
  }

  // Pickups
  for(let i=State.picks.length-1;i>=0;i--){
    const g=State.picks[i]; g.update(dt);
    if(!g.alive) State.picks.splice(i,1);
  }

  // Particles
  for(let i=State.parts.length-1;i>=0;i--){
    const p2=State.parts[i]; p2.update(dt);
    if(p2.life<=0){ partPool.release(p2); State.parts.splice(i,1); }
  }

  // Enemy contact damage
  if(State.player){
    for(let i=State.enemies.length-1;i>=0;i--){
      const e=State.enemies[i];
      if(circleHit(State.player.x,State.player.y,State.player.r, e.x,e.y,e.r)){
        State.player.hit(12 + Math.max(0, e.maxHP/12|0));
        AudioSys.thump();
        const dx=e.x-State.player.x, dy=e.y-State.player.y, m=Math.hypot(dx,dy)||1; e.x+=(dx/m)*12; e.y+=(dy/m)*12;
      }
    }
  }

  State.score += dt * 2; // time-based score
  updHUD();
}
function draw(){
  ctx.clearRect(0,0,W,H);
  Stars.draw(ctx);
  // draw order: particles, pickups, enemies, enemy bullets, player bullets, player
  for(const p of State.parts) p.draw(ctx);
  for(const g of State.picks) g.draw(ctx);
  for(const e of State.enemies) e.draw(ctx);
  for(const eb of State.eBullets) eb.draw(ctx);
  for(const b of State.bullets) b.draw(ctx);
  State.player?.draw(ctx);
}
function frame(ts){
  const t=ts/1000; let dt=t-State.time.last; State.time.last=t;
  if(dt>0.25) dt=0.25;
  State.time.acc += dt;

  // FPS
  State.time.fpsTime += dt; State.time.fpsCount++;
  if(State.time.fpsTime>=0.5){ State.time.fps=Math.round(State.time.fpsCount/State.time.fpsTime); State.time.fpsTime=0; State.time.fpsCount=0; }

  if(!State.running || State.paused){
    Stars.update(dt); draw(); requestAnimationFrame(frame); return;
  }

    const stepDt = State.time.fixed;
  while (State.time.acc >= stepDt) {
    step(stepDt);
    State.time.acc -= stepDt;
  }
  draw();
  requestAnimationFrame(frame);
}

// Boot
function boot() {
  Stars.init();
  showOnly(screens.menu);
  State.time.last = nowSec();
  requestAnimationFrame(frame);
}
boot();

})();
</script>
</body>
</html>
